#!/usr/bin/env python

import getopt
import sys
import os
import subprocess

# Internationalization
import locale
import gettext
gettext.install("spi", "/usr/share/locale", unicode=1)

slaptget = '/usr/sbin/slapt-get'
slaptsrc = '/usr/bin/slapt-src'

# create a copy of the default environment
initial_env = dict()

class Colours:
	RED = '\033[01;31m'
	GREEN = '\033[01;32m'
	RESET = '\033[00m'

	def disable(self):
		self.RED = ''
		self.GREEN = ''
		self.RESET = ''

colour = Colours()

def main(argv):
	try:
		opts, args = getopt.getopt(argv, "nhuUis", ["no-colour",
			"help", "update", "upgrade" , "install", "search", "simulate"])
		
		do_install = False
		do_simulate = False
		for opt, arg in opts:
			if opt in ("-n", "--no-colour"):
				colour.disable()
			elif opt in ("-h", "--help"):
				usage()
				sys.exit(0)
			elif opt in ("-u", "--update"):
				retval = update()
				sys.exit(retval)
			elif opt in ("-U", "--upgrade"):
				retval = upgrade()
				sys.exit(retval)
			elif opt in ("-i", "--install"):
				do_install = True
			elif opt in ("-s", "--simulate"):
				do_simulate = True
			elif opt in ("--search"):
				pass
		if not len(args) > 0:
			usage()
			sys.exit(0)
		if do_install:
			if do_simulate:
				simulate(args)
			else:
				install(args)
		else:
			search(args)

	except getopt.GetoptError:
		usage()
		sys.exit(1)

def check_for_root():
	if os.geteuid() != 0:
		print _('This action requires root privileges.')
		sys.exit(1)

def string_red(string):
	return colour.RED+string+colour.RESET

def string_green(string):
	return colour.GREEN+string+colour.RESET

def pkg_installed():
	pkg_installed = []
	for i in os.listdir('/var/log/packages'):
		pkg_installed.append(i.rpartition('-')[0].rpartition('-')[0].rpartition('-')[0])
	return pkg_installed

def pkglist(args):
	cmd = [slaptget, '--search']
	for arg in args:
		cmd.append(arg)
	env = dict()
	for i in initial_env:
		env[i] = initial_env[i]
	env['LANG'] = 'C'
	p = subprocess.Popen(cmd, stdout=subprocess.PIPE,
			stderr=subprocess.PIPE, env=env)
	pkglist_output = p.communicate()[0]
	status = p.returncode
	pkglist_output = pkglist_output.splitlines()
	pkgs = []
	pkgnames = []
	for line in pkglist_output:
		pkgfullname = line.partition('[inst=')[0]
		pkgshortname = pkgfullname.rpartition('-')[0].rpartition('-')[0].rpartition('-')[0]
		if pkgshortname not in pkgnames:
			pkgnames.append(pkgshortname)
			if pkgshortname in pkg_installed():
				pkginst = True
			else:
				pkginst = False
			pkgdesc = line.partition(']: ')[2] 
			pkgs.append([pkgshortname, pkginst, pkgdesc])
	return pkgs

def slackbuildlist(args):
	cmd = [slaptsrc, '--search']
	for arg in args:
		cmd.append(arg)
	env = dict()
	for i in initial_env:
		env[i] = initial_env[i]
	env['LANG'] = 'C'
	p = subprocess.Popen(cmd, stdout=subprocess.PIPE,
			stderr=subprocess.PIPE, env=env)
	pkglist_output = p.communicate()[0]
	status = p.returncode
	pkglist_output = pkglist_output.splitlines()
	pkgs = []
	pkgnames = []
	for line in pkglist_output:
		pkgfullname = line.partition(' - ')[0]
		pkgshortname = pkgfullname.rpartition(':')[0]
		if pkgshortname not in pkgnames:
			pkgnames.append(pkgshortname)
			if pkgshortname in pkg_installed():
				pkginst = True
			else:
				pkginst = False
			pkgdesc = line.partition(' - ')[2] 
			pkgs.append([pkgshortname, pkginst, pkgdesc])
	return pkgs

def search(args):
	print _('Available packages:')
	pl = pkglist(args)
	if pl == []:
		print _('None')
	else:
		for i in pl:
			pkgname, pkginst, pkgdesc  = i[0], i[1], i[2]
			if pkginst is True:
				pkginst = string_green(_('Installed'))
			else:
				pkginst = string_red(_('Not installed'))
			print pkgname+' ['+pkginst+']:', pkgdesc
	print "\n"+_('Available SlackBuilds:')
	sl = slackbuildlist(args)
	if sl == []:
		print _('None')
	else:
		for i in sl:
			pkgname, pkginst, pkgdesc  = i[0], i[1], i[2]
			if pkginst is True:
				pkginst = string_green(_('Installed'))
			else:
				pkginst = string_red(_('Not installed'))
			print pkgname+' ['+pkginst+']:', pkgdesc

def simulate(args, done=True, pqeue=[], sqeue=[], installed=[]):
	pl = pkglist(args)
	sl = slackbuildlist(args) 
	p = []
	for i in pl:
		p.append(i[0])
	s = []
	for i in sl:
		s.append(i[0])
	both = p+s
	if installed == []:
		installed = pkg_installed()
	for arg in args:
		if arg not in both:
			print _('No such package or SlackBuild:')+' '+arg
			sys.exit(1)
		if ((arg not in installed) and (arg not in pqeue) and (arg not in sqeue)):
			if arg in p:
				pqeue.append(arg)
			elif arg in s:
				sqeue.append(arg)
				simulate(slaptsrcdeps(arg), False, pqeue, sqeue, installed)
	if done:
		pqeue = sorted(slaptgetdeps(pqeue))
		sqeue = sorted(sqeue)
		if pqeue != []:
			print _('The following packages will be installed:'+'\n  '),
			for i in pqeue:
				print i,
		if sqeue != []:
			if pqeue != []:
				print "\n"
			print _('The following SlackBuilds will be installed:'+'\n  '),
			for i in sqeue:
				print i,
		if ((pqeue == []) and (sqeue == [])):
			print _('Nothing to install')
		else:
			print ""

def install(args):
	check_for_root()
	pl = pkglist(args)
	sl = slackbuildlist(args)
	p = []
	for i in pl:
		p.append(i[0])
	s = []
	for i in sl:
		s.append(i[0])
	for arg in args:
		if arg not in pkg_installed():
			if arg in p:
				installpkg(arg)
			elif arg in s:
				installsb(arg)
			else:
				print _('No such package or SlackBuild:')+' '+arg
				sys.exit(1)

def installpkg(pkg):
	p = subprocess.Popen([slaptget, '--no-prompt', '--install',
		pkg])
	retval = p.wait()
	if retval != 0:
		sys.exit(retval)

def installsb(slackbuild):
	deps = slaptsrcdeps(slackbuild)
	if deps != []:
		install(deps)
	p = subprocess.Popen([slaptsrc, '--no-dep', '--yes', '--install',
		slackbuild])
	retval = p.wait()
	if retval != 0:
		sys.exit(retval)

def update():
	check_for_root()
	print _('Updating package cache...')
	p = subprocess.Popen([slaptget, '--update'])
	retval = p.wait()
	if retval == 0:
		print "\n"+_('Updating SlackBuild cache...')
		p = subprocess.Popen([slaptsrc, '--update'])
		retval = p.wait()
	return retval

def upgrade():
	check_for_root()
	p = subprocess.Popen([slaptget, '--upgrade'])
	retval = p.wait()
	return retval

def slaptgetdeps(pkgs):
	deps = []
	DEVNULL = open('/dev/null', 'w')
	args = [slaptget, '--simulate', '--install']
	for i in pkgs:
		args.append(i)
	env = dict()
	for i in initial_env:
		env[i] = initial_env[i]
	env['LANG'] = 'C'
	p = subprocess.Popen(args, stdout=subprocess.PIPE, stderr=DEVNULL, env=env)
	output = p.communicate()[0]
	data = ''
	for line in output.splitlines():
		if line.endswith(' is to be installed'):
			data = line.rpartition(' is to be installed')[0].rpartition('-')[0].rpartition('-')[0].rpartition('-')[0]
			if data is not '':
				if data not in deps:
					deps.append(data)
	DEVNULL.close()
	return deps

def slaptsrcdeps(pkg):
	deps = []
	DEVNULL = open('/dev/null', 'w')
	args = [slaptsrc, '--show', pkg]
	env = dict()
	for i in initial_env:
		env[i] = initial_env[i]
	env['LANG'] = 'C'
	p = subprocess.Popen(args, stdout=subprocess.PIPE, stderr=DEVNULL, env=env)
	output = p.communicate()[0]
	data = ''
	for line in output.splitlines():
		if line.startswith('SlackBuild Requires:'):
			data = line.partition(':')[2]
	newdeps = data.replace('\n', ',').strip(' ').split(',')
	for i in newdeps:
		if i is not '' and i != '%README%':
			if i not in deps:
				deps.append(i)
	DEVNULL.close()
	return deps

def usage():
	print _('USAGE:'), os.path.basename(sys.argv[0]),_('[OPTIONS] [STRING(s)]')
	print
	print 'OPTIONS:'
	print '       --search      ',_('search for specified packages (default action)')
	print '   -u, --update      ',_('update package and SlackBuild caches')
	print '   -U, --upgrade     ',_('upgrade packages')
	print '   -s, --simulate    ',_('simulate installation of specified packages')
	print '   -i, --install     ',_('install specified packages')
	print '   -n, --no-colour   ',_('disable colour output')
	print '   -h, --help        ',_('this help message')


if __name__ == "__main__":
	try:
		main(sys.argv[1:])
	except KeyboardInterrupt:
		sys.exit(2)
